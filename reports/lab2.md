chapter4 练习

# 实验总结

# 问答作业

-------------------------------------------------

1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？

页表项格式如下：
```
 63      54 53      28 27      19 18      10 9   8 7 6 5 4 3 2 1 0
+----------+----------+----------+----------+-----+-+-+-+-+-+-+-+-+
| reserved |  PPN[2]  |  PPN[1]  |  PPN[0]  | RSW |D|A|G|U|X|W|R|V|
+----------+----------+----------+----------+-----+-+-+-+-+-+-+-+-+
     10         26          9          9       2   1 1 1 1 1 1 1 1
```

其中：

* V：有效位，表示页表项是否 valid。
* R, W, X：这些位分别表示页面是否可读、可写和可执行。当所有三个都为零时，PTE 指向页面表的下一级；否则，它是一个 leaf PTE。
* U：用户位，表示对应虚拟页面是否可在用户态下访问。
* G：全局位，表示对应的页面是否是全局的。对于 non-leaf PTE，全局设置意味着页表后续级别中的所有映射都是全局的。请注意，未能将全局映射标记为全局只会降低性能，而将非全局映射标记为全局则是一个致命错误。
* A：访问位，表示对应的页面是否被访问过。
* D：脏位，表示对应的页面是否被写过。
* RSW：为内核程序预留，硬件不会对此做任何其他操作。
下表列出了所有可能的 R, W, X 组合：

```
X	W	R	Meaning
0	0	0	Pointer to next level of page table.
0	0	1	Read-only page.
0	1	0	Reserved for future use.
0	1	1	Read-write page.
1	0	0	Execute-only page.
1	0	1	Read-execute page.
1	1	0	Reserved for future use.
1	1	1	Read-write-execute page.
```

2. 缺页
    缺页指的是进程访问页面时页面不在页表中或在页表中无效的现象，此时 MMU 将会返回一个中断，
    告知 os 进程内存访问出了问题。os 选择填补页表并重新执行异常指令或者杀死进程。

    - 请问哪些异常可能是缺页导致的？答：page fault 或者 store/load fault
    - 发生缺页时，描述相关重要寄存器的值，上次实验描述过的可以简略。答：

    缺页有两个常见的原因，其一是 Lazy 策略，也就是直到内存页面被访问才实际进行页表操作。
    比如，一个程序被执行时，进程的代码段理论上需要从磁盘加载到内存。但是 os 并不会马上这样做，
    而是会保存 .text 段在磁盘的位置信息，在这些代码第一次被执行时才完成从磁盘的加载操作。

    - 这样做有哪些好处？答：任务不一定会把申请的内存空间全部用尽，用时映射，可以最大化提高内存使用率。

    其实，我们的 mmap 也可以采取 Lazy 策略，比如：一个用户进程先后申请了 10G 的内存空间，
    然后用了其中 1M 就直接退出了。按照现在的做法，我们显然亏大了，进行了很多没有意义的页表操作。

    - 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)？答：(10G / 4KiB) * 8 Byte
    - 请简单思考如何才能实现 Lazy 策略，缺页时又如何处理？描述合理即可，不需要考虑实现。答：可以在 TCB 记录内存映射关系，缺页时进入异常处理函数内，再进行实际的映射。

    缺页的另一个常见原因是 swap 策略，也就是内存页面可能被换到磁盘上了，导致对应页面失效。

    - 此时页面失效如何表现在页表项(PTE)上？ 答：将 V 位设置为 0 ，表示该页失效。

3. 双页表与单页表

   为了防范侧信道攻击，我们的 os 使用了双页表。但是传统的设计一直是单页表的，也就是说，
   用户线程和对应的内核线程共用同一张页表，只不过内核对应的地址只允许在内核态访问。
   (备注：这里的单/双的说法仅为自创的通俗说法，并无这个名词概念，详情见 `KPTI <https://en.wikipedia.org/wiki/Kernel_page-table_isolation>`_ )

   - 在单页表情况下，如何更换页表？答：只能通过陷入内核态，建立页表的重新映射。
   - 单页表情况下，如何控制用户态无法访问内核页面？（tips:看看上一题最后一问）答：PTE的U位设置为0，则只能在内核态访问
   - 单页表有何优势？（回答合理即可）答：设计相对简单，更加可控。
   - 双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？答：发生系统调用，切换到内核态，可能需要切换页表。单页表操作系统，一般不需要切换页表，除非发生页面置换。
